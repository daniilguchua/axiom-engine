<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHOST DEBUG // Sanitizer Tournament</title>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@11.3.0/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">

    <style>
        /* Override main stylesheet for debug page */
        html, body {
            background: #0a0a0f !important;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            height: auto !important;
            overflow: auto !important;
            display: block !important;
        }

        .debug-container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .debug-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(188, 19, 254, 0.3);
        }

        .debug-header h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2.5em;
            margin: 0;
            color: #bc13fe;
        }

        .debug-header p {
            font-size: 0.9em;
            color: #888;
            margin: 10px 0 0 0;
        }

        .debug-header a {
            color: #00f3ff;
            text-decoration: none;
        }

        .test-form {
            background: rgba(20, 20, 30, 0.6);
            border: 1px solid rgba(188, 19, 254, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .test-form h2 {
            margin-top: 0;
            color: #bc13fe;
            font-size: 1.3em;
        }

        .test-form textarea {
            width: 100%;
            min-height: 150px;
            background: #0a0a0f;
            border: 1px solid rgba(0, 243, 255, 0.3);
            border-radius: 4px;
            color: #e0e0e0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            padding: 10px;
            resize: vertical;
            box-sizing: border-box;
        }

        .test-form button {
            background: linear-gradient(135deg, #bc13fe, #8b10c7);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            margin-top: 10px;
        }

        .test-form button:hover {
            opacity: 0.9;
        }

        .test-form button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .stats-panel {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 600px) {
            .stats-panel {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .stat-card {
            background: rgba(20, 20, 30, 0.6);
            border: 1px solid rgba(0, 243, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 0.9em;
            color: #888;
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: 700;
            color: #00f3ff;
        }

        .pipeline-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .pipeline-card {
            background: rgba(20, 20, 30, 0.6);
            border: 1px solid rgba(0, 243, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
        }

        .pipeline-card.success {
            border-color: rgba(52, 211, 153, 0.6);
        }

        .pipeline-card.error {
            border-color: rgba(248, 113, 113, 0.6);
        }

        .pipeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .pipeline-name {
            font-weight: 700;
            font-size: 1.1em;
            color: #bc13fe;
        }

        .pipeline-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .pipeline-status.success {
            background: rgba(52, 211, 153, 0.2);
            color: #34D399;
        }

        .pipeline-status.error {
            background: rgba(248, 113, 113, 0.2);
            color: #F87171;
        }

        .pipeline-code {
            background: #0a0a0f;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85em;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
            color: #e0e0e0;
        }

        .pipeline-error {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.3);
            border-radius: 4px;
            padding: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85em;
            color: #F87171;
            margin-bottom: 10px;
        }

        .pipeline-render {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 243, 255, 0.2);
            border-radius: 4px;
            padding: 10px;
            min-height: 150px;
            overflow: auto;
        }

        .recent-tests {
            margin-top: 40px;
        }

        .recent-tests h2 {
            color: #bc13fe;
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        .test-item {
            background: rgba(20, 20, 30, 0.8);
            border: 1px solid rgba(0, 243, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .test-item:hover {
            background: rgba(30, 30, 45, 0.9);
        }

        .test-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .test-id {
            font-weight: 700;
            color: #00f3ff;
        }

        .best-method {
            padding: 4px 10px;
            background: rgba(188, 19, 254, 0.2);
            border-radius: 12px;
            font-size: 0.9em;
            color: #bc13fe;
        }

        .expand-btn {
            background: rgba(0, 243, 255, 0.2);
            border: 1px solid rgba(0, 243, 255, 0.3);
            color: #00f3ff;
            padding: 6px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .expand-btn:hover {
            background: rgba(0, 243, 255, 0.3);
        }

        .test-details {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .test-details.expanded {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
    </style>
</head>

<body>
    <div class="debug-container">
        <div class="debug-header">
            <h1>‚ö° GHOST DEBUG</h1>
            <p>Sanitizer Tournament - Compare all 5 repair pipelines side-by-side</p>
            <p><a href="index.html" style="color: #00f3ff;">‚Üê Back to Main App</a></p>
        </div>

        <!-- Submit New Test -->
        <div class="test-form">
            <h2>üß™ Test Raw Mermaid Code</h2>
            <p style="color: #888; font-size: 0.9em;">Paste raw LLM output to test through all 5 sanitization pipelines</p>
            <textarea id="raw-input" placeholder="flowchart LR;&#10;A['Start'];&#10;B['Process'];&#10;A --> B;"></textarea>
            <button id="submit-test" onclick="submitTest()">Run Test</button>
            <div id="test-status" style="margin-top: 10px; color: #888;"></div>
        </div>

        <!-- Statistics Panel -->
        <div class="stats-panel" id="stats-panel">
            <div class="stat-card">
                <h3>Total Tests</h3>
                <div class="value" id="stat-total">-</div>
            </div>
            <div class="stat-card">
                <h3>RAW Success</h3>
                <div class="value" id="stat-raw">-</div>
            </div>
            <div class="stat-card">
                <h3>Python Sanitizer</h3>
                <div class="value" id="stat-python">-</div>
            </div>
            <div class="stat-card">
                <h3>Mermaid.js Fix</h3>
                <div class="value" id="stat-mermaidjs">-</div>
            </div>
            <div class="stat-card">
                <h3>Python ‚Üí JS</h3>
                <div class="value" id="stat-python-js">-</div>
            </div>
            <div class="stat-card">
                <h3>JS ‚Üí Python</h3>
                <div class="value" id="stat-js-python">-</div>
            </div>
        </div>

        <!-- Current Test Results -->
        <div id="current-test" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #bc13fe; margin: 0;">Current Test Results</h2>
                <button onclick="showCodeComparison()" style="background: rgba(0, 243, 255, 0.2); border: 1px solid rgba(0, 243, 255, 0.3); color: #00f3ff; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Compare Code Changes</button>
            </div>
            <div class="pipeline-comparison" id="pipeline-results"></div>

            <!-- Code Comparison Modal -->
            <div id="comparison-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 1000; overflow-y: auto; padding: 20px;">
                <div style="max-width: 1400px; margin: 0 auto; background: #0a0a0f; border: 2px solid rgba(188, 19, 254, 0.5); border-radius: 8px; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #bc13fe; margin: 0;">üìä Code Transformation Comparison</h2>
                        <button onclick="closeComparison()" style="background: rgba(248, 113, 113, 0.2); border: 1px solid rgba(248, 113, 113, 0.3); color: #F87171; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Close</button>
                    </div>
                    <div id="comparison-content"></div>
                </div>
            </div>
        </div>

        <!-- Recent Tests -->
        <div class="recent-tests">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üìä Recent Tests</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="filter-method" onchange="filterTests()" style="background: rgba(20, 20, 30, 0.6); color: #e0e0e0; border: 1px solid rgba(0, 243, 255, 0.3); padding: 8px; border-radius: 4px; cursor: pointer;">
                        <option value="all">All Methods</option>
                        <option value="RAW">RAW Only</option>
                        <option value="PYTHON">Python Only</option>
                        <option value="MERMAIDJS">Mermaid.js Only</option>
                        <option value="PYTHON_THEN_JS">Python‚ÜíJS Only</option>
                        <option value="JS_THEN_PYTHON">JS‚ÜíPython Only</option>
                    </select>
                    <select id="filter-result" onchange="filterTests()" style="background: rgba(20, 20, 30, 0.6); color: #e0e0e0; border: 1px solid rgba(0, 243, 255, 0.3); padding: 8px; border-radius: 4px; cursor: pointer;">
                        <option value="all">All Results</option>
                        <option value="success">Success Only</option>
                        <option value="failure">Failures Only</option>
                    </select>
                    <label style="color: #94A3B8; font-size: 0.9em; display: flex; align-items: center; gap: 6px;">
                        <input type="checkbox" id="auto-refresh" checked onchange="toggleAutoRefresh(this)" style="cursor: pointer;">
                        Auto-refresh (5s)
                    </label>
                    <button onclick="loadRecentTests()" style="background: rgba(0, 243, 255, 0.2); border: 1px solid rgba(0, 243, 255, 0.3); color: #00f3ff; padding: 8px 15px; border-radius: 4px; cursor: pointer;">üîÑ Refresh</button>
                    <button onclick="exportTests()" style="background: rgba(0, 243, 255, 0.2); border: 1px solid rgba(0, 243, 255, 0.3); color: #00f3ff; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Export CSV</button>
                    <button onclick="clearAllTests()" style="background: rgba(248, 113, 113, 0.2); border: 1px solid rgba(248, 113, 113, 0.3); color: #F87171; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Clear All</button>
                </div>
            </div>
            <div id="recent-tests-list">
                <div class="loading">Loading recent tests...</div>
            </div>
        </div>

        <!-- Error Log Section -->
        <div class="recent-tests" style="margin-top: 40px; border-top: 2px solid rgba(248, 113, 113, 0.3); padding-top: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #F87171;">Error Log</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="error-pipeline-filter" onchange="renderErrorLog()" style="background: rgba(20, 20, 30, 0.6); color: #e0e0e0; border: 1px solid rgba(248, 113, 113, 0.3); padding: 8px; border-radius: 4px; cursor: pointer;">
                        <option value="all">All Pipelines</option>
                        <option value="raw">RAW Errors</option>
                        <option value="python">Python Errors</option>
                        <option value="mermaidjs">Mermaid.js Errors</option>
                        <option value="python_then_js">Python‚ÜíJS Errors</option>
                        <option value="js_then_python">JS‚ÜíPython Errors</option>
                    </select>
                    <button onclick="renderErrorLog()" style="background: rgba(248, 113, 113, 0.2); border: 1px solid rgba(248, 113, 113, 0.3); color: #F87171; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Refresh</button>
                </div>
            </div>

            <!-- Error Panels Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                <!-- Error Frequency Chart -->
                <div id="error-frequency" style="background: rgba(20, 20, 30, 0.8); border: 1px solid rgba(248, 113, 113, 0.3); border-radius: 12px; padding: 20px;">
                    <h3 style="color: #F87171; margin: 0 0 15px 0; font-size: 1.1em;">Most Common Errors (by frequency)</h3>
                    <div id="error-frequency-list" style="max-height: 600px; overflow-y: auto;">
                        <div class="loading">Analyzing errors...</div>
                    </div>
                </div>

                <!-- Full Error List -->
                <div id="error-list" style="background: rgba(20, 20, 30, 0.8); border: 1px solid rgba(248, 113, 113, 0.3); border-radius: 12px; padding: 20px;">
                    <h3 style="color: #F87171; margin: 0 0 15px 0; font-size: 1.1em;">All Errors (most recent first)</h3>
                    <div id="error-list-items" style="max-height: 600px; overflow-y: auto;">
                        <div class="loading">Loading errors...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Full-screen Test Viewer Modal -->
    <div id="test-viewer-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 2000; overflow-y: auto;">
        <div style="max-width: 1800px; margin: 0 auto; padding: 30px;">
            <!-- Modal Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid rgba(188, 19, 254, 0.5);">
                <div>
                    <h1 id="modal-title" style="color: #bc13fe; margin: 0; font-size: 1.8em;">Test #0</h1>
                    <p id="modal-subtitle" style="color: #888; margin: 10px 0 0 0;"></p>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button onclick="navigateTest(-1)" style="background: rgba(0, 243, 255, 0.2); border: 1px solid rgba(0, 243, 255, 0.3); color: #00f3ff; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 1em;">‚Üê Previous</button>
                    <button onclick="navigateTest(1)" style="background: rgba(0, 243, 255, 0.2); border: 1px solid rgba(0, 243, 255, 0.3); color: #00f3ff; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 1em;">Next ‚Üí</button>
                    <button onclick="closeTestViewer()" style="background: rgba(248, 113, 113, 0.2); border: 1px solid rgba(248, 113, 113, 0.3); color: #F87171; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 1em;">‚úï Close</button>
                </div>
            </div>

            <!-- Pipeline Cards Grid -->
            <div id="modal-pipelines" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;"></div>
        </div>
    </div>

    <script>
        // API URL - must match Flask server
        const API_URL = 'http://127.0.0.1:5000';

        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            securityLevel: 'loose',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true
            }
        });

        // Auto-refresh test results
        let refreshInterval = null;

        function startAutoRefresh() {
            if (refreshInterval) return; // Already running
            
            refreshInterval = setInterval(() => {
                console.log('[DEBUG.HTML] Auto-refreshing test results...');
                loadRecentTests();
                loadStats();
            }, 5000); // Refresh every 5 seconds
            
            console.log('[DEBUG.HTML] Auto-refresh started (5s interval)');
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
                console.log('[DEBUG.HTML] Auto-refresh stopped');
            }
        }

        // Load stats and recent tests on page load
        window.addEventListener('load', () => {
            console.log('[DEBUG] Page loaded, fetching from:', API_URL);
            loadStats();
            loadRecentTests();
            startAutoRefresh(); // Start auto-refresh
        });

        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/debug/stats?days=7`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('stat-total').textContent = data.total_tests || 0;
                    document.getElementById('stat-raw').textContent = data.raw_success || 0;
                    document.getElementById('stat-python').textContent = data.python_success || 0;
                    document.getElementById('stat-mermaidjs').textContent = data.mermaidjs_success || 0;
                    document.getElementById('stat-python-js').textContent = data.python_then_js_success || 0;
                    document.getElementById('stat-js-python').textContent = data.js_then_python_success || 0;
                }
            } catch (e) {
                console.error('Error loading stats:', e);
            }
        }


        function renderTestItem(test) {
            // Count how many pipelines succeeded
            const results = [
                { name: 'RAW', ok: test.raw_rendered },
                { name: 'Py', ok: test.python_rendered },
                { name: 'JS', ok: test.mermaidjs_rendered },
                { name: 'Py‚ÜíJS', ok: test.python_then_js_rendered },
                { name: 'JS‚ÜíPy', ok: test.js_then_python_rendered }
            ];
            const successCount = results.filter(r => r.ok).length;

            // Create mini status pills
            const statusPills = results.map(r =>
                `<span style="display: inline-block; padding: 4px 8px; margin: 0 3px; border-radius: 6px; font-size: 0.8em; font-weight: 500; background: ${r.ok ? 'rgba(52, 211, 153, 0.3)' : 'rgba(248, 113, 113, 0.3)'}; color: ${r.ok ? '#34D399' : '#F87171'};">${r.name} ${r.ok ? '‚úì' : '‚úó'}</span>`
            ).join('');

            // Preview of raw mermaid (first 100 chars)
            const preview = (test.raw_mermaid || '').substring(0, 100).replace(/\n/g, ' ');

            return `
                <div class="test-item" style="cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent;" onclick="toggleTestDetails(${test.id})" onmouseover="this.style.borderColor='rgba(188, 19, 254, 0.5)'" onmouseout="this.style.borderColor='transparent'">
                    <div class="test-item-header" style="flex-wrap: wrap; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                            <span class="test-id" style="font-size: 1.1em;">Test #${test.id}</span>
                            <span class="best-method" style="font-size: 0.95em;">${test.best_method || 'NONE'}</span>
                            <span style="color: ${successCount > 0 ? '#34D399' : '#F87171'}; font-weight: 700; font-size: 1.1em;">${successCount}/5</span>
                            <span style="color: #888; font-size: 0.85em;">${new Date(test.created_at).toLocaleString()}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            ${statusPills}
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 0.8em; color: #888;">
                        ${escapeHtml(preview)}${preview.length >= 100 ? '...' : ''}
                    </div>
                    <div style="margin-top: 10px; text-align: center; color: #00f3ff; font-size: 0.9em;">Click to view full details ‚Üí</div>
                </div>
            `;
        }

        function renderPipelineCard(name, output, error, rendered) {
            const statusClass = rendered ? 'success' : 'error';
            const statusText = rendered ? '‚úì Rendered' : '‚úó Failed';
            const codeId = `code-${Math.random().toString(36).substring(7)}`;
            const renderId = `render-${Math.random().toString(36).substring(7)}`;

            return `
                <div class="pipeline-card ${statusClass}" onclick="event.stopPropagation();">
                    <div class="pipeline-header">
                        <div class="pipeline-name">${name}</div>
                        <div class="pipeline-status ${statusClass}">${statusText}</div>
                    </div>
                    ${error ? `<div class="pipeline-error"><strong>Error:</strong> ${escapeHtml(error).substring(0, 200)}${(error || '').length > 200 ? '...' : ''}</div>` : ''}

                    <!-- Render Preview Button -->
                    ${rendered && output ? `
                        <button onclick="renderMermaidPreview('${renderId}', \`${escapeForAttribute(output)}\`)" style="background: rgba(52, 211, 153, 0.2); border: 1px solid rgba(52, 211, 153, 0.3); color: #34D399; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; margin-bottom: 10px; width: 100%;">Show Graph Preview</button>
                        <div id="${renderId}" class="pipeline-render" style="display: none;"></div>
                    ` : ''}

                    <div class="pipeline-code" style="max-height: 120px; cursor: pointer; font-size: 0.8em;" onclick="toggleCodeView('${codeId}')">
                        <div style="color: #888; font-size: 0.75em; margin-bottom: 5px;">Click to view code (${(output || '').length} chars)</div>
                        ${escapeHtml(output || 'N/A').substring(0, 150)}${(output || '').length > 150 ? '...' : ''}
                    </div>
                    <div id="${codeId}" style="display: none; background: #000; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px; padding: 10px; margin-top: 10px; max-height: 400px; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 10px;">
                            <strong style="color: #00f3ff;">Full Code</strong>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="copyCode('${codeId}')" style="background: rgba(0, 243, 255, 0.2); border: 1px solid rgba(0, 243, 255, 0.3); color: #00f3ff; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85em;">Copy</button>
                            </div>
                        </div>
                        <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word; font-family: 'JetBrains Mono', monospace; font-size: 0.8em; color: #e0e0e0; line-height: 1.4;">${escapeHtml(output || 'N/A')}</pre>
                    </div>
                </div>
            `;
        }

        function escapeForAttribute(str) {
            return str.replace(/`/g, '\\`').replace(/\$/g, '\\$');
        }

        async function renderMermaidPreview(containerId, code) {
            const container = document.getElementById(containerId);
            if (container.style.display === 'none') {
                container.style.display = 'block';
                container.innerHTML = '<div style="color: #888; padding: 20px; text-align: center;">Rendering...</div>';

                try {
                    // Clean the code
                    const cleanCode = code.replace(/\\`/g, '`').replace(/\\\$/g, '$');

                    // Create a unique ID for this render
                    const svgId = 'mermaid-' + Math.random().toString(36).substring(7);

                    const { svg } = await mermaid.render(svgId, cleanCode);
                    container.innerHTML = svg;
                } catch (e) {
                    container.innerHTML = `<div style="color: #F87171; padding: 10px;">Failed to render: ${escapeHtml(e.message)}</div>`;
                }
            } else {
                container.style.display = 'none';
            }
        }

        function toggleCodeView(codeId) {
            const element = document.getElementById(codeId);
            if (element.style.display === 'none') {
                element.style.display = 'block';
            } else {
                element.style.display = 'none';
            }
        }

        function copyCode(codeId) {
            const element = document.getElementById(codeId);
            const code = element.querySelector('pre').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('‚úÖ Code copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('‚ùå Failed to copy code');
            });
        }

        function downloadCode(codeId, pipelineName) {
            const element = document.getElementById(codeId);
            const code = element.querySelector('pre').textContent;
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mermaid-${pipelineName.toLowerCase().replace(/\s+/g, '-')}-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Store current test results for comparison
        let currentTestData = null;

        function showCodeComparison() {
            if (!currentTestData) {
                alert('No test data available');
                return;
            }

            const modal = document.getElementById('comparison-modal');
            const content = document.getElementById('comparison-content');

            const pipelines = ['raw', 'python', 'mermaidjs', 'python_then_js', 'js_then_python'];
            const names = {
                'raw': 'RAW (No Changes)',
                'python': 'Python Sanitizer',
                'mermaidjs': 'Mermaid.js Fixer',
                'python_then_js': 'Python ‚Üí JS',
                'js_then_python': 'JS ‚Üí Python'
            };

            let html = '<div style="display: grid; gap: 20px;">';

            // Show each pipeline's code with character count
            for (const pipeline of pipelines) {
                const data = currentTestData[pipeline];
                const code = data.output || '';
                const lines = code.split('\n');

                html += `
                    <div style="background: rgba(20, 20, 30, 0.6); border: 1px solid rgba(0, 243, 255, 0.3); border-radius: 8px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 10px;">
                            <strong style="color: #bc13fe; font-size: 1.1em;">${names[pipeline]}</strong>
                            <div style="color: #888; font-size: 0.9em;">
                                ${code.length} chars | ${lines.length} lines |
                                <span style="color: ${data.rendered ? '#34D399' : '#F87171'};">${data.rendered ? '‚úì Rendered' : '‚úó Failed'}</span>
                            </div>
                        </div>
                        ${data.error ? `<div style="background: rgba(248, 113, 113, 0.1); border: 1px solid rgba(248, 113, 113, 0.3); padding: 8px; margin-bottom: 10px; border-radius: 4px; color: #F87171; font-size: 0.9em;"><strong>Error:</strong> ${escapeHtml(data.error)}</div>` : ''}
                        <pre style="background: #000; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px; padding: 10px; margin: 0; max-height: 300px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; font-family: 'JetBrains Mono', monospace; font-size: 0.85em; color: #e0e0e0; line-height: 1.5;">${escapeHtml(code)}</pre>
                    </div>
                `;
            }

            html += '</div>';
            content.innerHTML = html;
            modal.style.display = 'block';
        }

        function closeComparison() {
            document.getElementById('comparison-modal').style.display = 'none';
        }

        // Current test index for navigation
        let currentViewingTestIndex = 0;

        function toggleTestDetails(testId) {
            // Find the test and open in modal
            const test = allTests.find(t => t.id === testId);
            if (test) {
                currentViewingTestIndex = allTests.indexOf(test);
                openTestViewer(test);
            }
        }

        function openTestViewer(test) {
            const modal = document.getElementById('test-viewer-modal');
            const title = document.getElementById('modal-title');
            const subtitle = document.getElementById('modal-subtitle');
            const pipelines = document.getElementById('modal-pipelines');

            // Count successes
            const results = [
                { name: 'RAW', ok: test.raw_rendered },
                { name: 'Python', ok: test.python_rendered },
                { name: 'Mermaid.js', ok: test.mermaidjs_rendered },
                { name: 'Python‚ÜíJS', ok: test.python_then_js_rendered },
                { name: 'JS‚ÜíPython', ok: test.js_then_python_rendered }
            ];
            const successCount = results.filter(r => r.ok).length;

            title.textContent = `Test #${test.id}`;
            subtitle.innerHTML = `
                <span style="color: ${successCount > 0 ? '#34D399' : '#F87171'}; font-weight: 600;">${successCount}/5 pipelines passed</span>
                &nbsp;‚Ä¢&nbsp; Best: <span style="color: #bc13fe;">${test.best_method || 'NONE'}</span>
                &nbsp;‚Ä¢&nbsp; ${new Date(test.created_at).toLocaleString()}
                &nbsp;‚Ä¢&nbsp; Test ${currentViewingTestIndex + 1} of ${allTests.length}
            `;

            // Render pipeline cards
            pipelines.innerHTML = `
                ${renderModalPipelineCard('RAW (Original LLM Output)', test.raw_mermaid, test.raw_error, test.raw_rendered)}
                ${renderModalPipelineCard('Python Sanitizer', test.python_output, test.python_error, test.python_rendered)}
                ${renderModalPipelineCard('Mermaid.js Fixer', test.mermaidjs_output, test.mermaidjs_error, test.mermaidjs_rendered)}
                ${renderModalPipelineCard('Python ‚Üí JS', test.python_then_js_output, test.python_then_js_error, test.python_then_js_rendered)}
                ${renderModalPipelineCard('JS ‚Üí Python', test.js_then_python_output, test.js_then_python_error, test.js_then_python_rendered)}
            `;

            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function renderModalPipelineCard(name, output, error, rendered) {
            const statusClass = rendered ? 'success' : 'error';
            const statusText = rendered ? '‚úì RENDERED' : '‚úó FAILED';
            const renderId = `modal-render-${Math.random().toString(36).substring(7)}`;
            const codeLength = (output || '').length;

            return `
                <div style="background: rgba(20, 20, 30, 0.8); border: 2px solid ${rendered ? 'rgba(52, 211, 153, 0.5)' : 'rgba(248, 113, 113, 0.5)'}; border-radius: 12px; padding: 20px;">
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                        <h3 style="margin: 0; color: #bc13fe; font-size: 1.2em;">${name}</h3>
                        <span style="padding: 6px 14px; border-radius: 20px; font-size: 0.9em; font-weight: 600; background: ${rendered ? 'rgba(52, 211, 153, 0.2)' : 'rgba(248, 113, 113, 0.2)'}; color: ${rendered ? '#34D399' : '#F87171'};">${statusText}</span>
                    </div>

                    ${error ? `
                        <div style="background: rgba(248, 113, 113, 0.1); border: 1px solid rgba(248, 113, 113, 0.3); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                            <strong style="color: #F87171;">Error:</strong>
                            <pre style="margin: 8px 0 0 0; color: #F87171; font-size: 0.85em; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(error)}</pre>
                        </div>
                    ` : ''}

                    <!-- Graph Preview Button -->
                    ${rendered && output ? `
                        <button onclick="renderMermaidPreview('${renderId}', \`${escapeForAttribute(output)}\`)" style="background: rgba(52, 211, 153, 0.2); border: 1px solid rgba(52, 211, 153, 0.4); color: #34D399; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; width: 100%; margin-bottom: 15px; font-weight: 600;">Show Graph Preview</button>
                        <div id="${renderId}" class="pipeline-render" style="display: none; background: rgba(0, 0, 0, 0.4); border-radius: 8px; padding: 20px; margin-bottom: 15px;"></div>
                    ` : ''}

                    <!-- Code Display -->
                    <div style="background: #1a1a2e; border: 1px solid rgba(0, 243, 255, 0.3); border-radius: 8px; overflow: hidden;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: rgba(0, 243, 255, 0.1); border-bottom: 1px solid rgba(0, 243, 255, 0.2);">
                            <span style="color: #00f3ff; font-weight: 600; font-size: 0.95em;">Mermaid Code (${codeLength} chars, ${(output || '').split('\\n').length} lines)</span>
                            <button onclick="navigator.clipboard.writeText(\`${escapeForAttribute(output || '')}\`).then(() => alert('Copied!'))" style="background: rgba(0, 243, 255, 0.2); border: 1px solid rgba(0, 243, 255, 0.3); color: #00f3ff; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">Copy Code</button>
                        </div>
                        <pre style="margin: 0; padding: 15px; white-space: pre-wrap; word-wrap: break-word; font-family: 'JetBrains Mono', monospace; font-size: 0.95em; color: #a8d8ff; line-height: 1.7; max-height: 400px; overflow-y: auto; background: #0d1117;">${highlightMermaidCode(output || 'N/A')}</pre>
                    </div>
                </div>
            `;
        }

        function closeTestViewer() {
            document.getElementById('test-viewer-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function navigateTest(direction) {
            const newIndex = currentViewingTestIndex + direction;
            if (newIndex >= 0 && newIndex < allTests.length) {
                currentViewingTestIndex = newIndex;
                openTestViewer(allTests[newIndex]);
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeTestViewer();
                closeComparison();
            }
            if (e.key === 'ArrowLeft') navigateTest(-1);
            if (e.key === 'ArrowRight') navigateTest(1);
        });

        async function submitTest() {
            const rawInput = document.getElementById('raw-input').value.trim();
            const submitBtn = document.getElementById('submit-test');
            const statusDiv = document.getElementById('test-status');

            if (!rawInput) {
                statusDiv.textContent = '‚ö†Ô∏è Please enter Mermaid code';
                statusDiv.style.color = '#F87171';
                return;
            }

            submitBtn.disabled = true;
            statusDiv.textContent = 'üîÑ Testing through all pipelines...';
            statusDiv.style.color = '#00f3ff';

            try {
                // Step 1: Capture raw and get pipeline versions
                const captureResponse = await fetch(`${API_URL}/debug/capture-raw`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        raw_mermaid: rawInput,
                        session_id: 'debug_session',
                        prompt: 'Manual debug test'
                    })
                });

                const captureData = await captureResponse.json();

                if (!captureData.success) {
                    throw new Error(captureData.error || 'Failed to capture');
                }

                // Step 2: Test each pipeline
                const testResults = {};
                const pipelines = ['raw', 'python', 'mermaidjs', 'python_then_js', 'js_then_python'];

                for (const pipeline of pipelines) {
                    const code = captureData.pipelines[pipeline];
                    const result = await testMermaidRendering(code, pipeline);
                    testResults[pipeline] = result;
                }

                // Step 3: Display results
                displayResults(testResults);

                // Step 4: Log to database
                await fetch(`${API_URL}/debug/log-test-results`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        raw_mermaid: rawInput,
                        session_id: 'debug_session',
                        test_results: testResults
                    })
                });

                statusDiv.textContent = '‚úÖ Test complete! Results displayed below.';
                statusDiv.style.color = '#34D399';

                // Refresh stats and recent tests
                loadStats();
                loadRecentTests();

            } catch (error) {
                console.error('Test error:', error);
                statusDiv.textContent = `‚ùå Error: ${error.message}`;
                statusDiv.style.color = '#F87171';
            } finally {
                submitBtn.disabled = false;
            }
        }

        async function testMermaidRendering(code, pipelineName) {
            return new Promise((resolve) => {
                const testDiv = document.createElement('div');
                testDiv.className = 'mermaid';
                testDiv.style.display = 'none';
                testDiv.textContent = code;
                document.body.appendChild(testDiv);

                mermaid.run({ nodes: [testDiv] })
                    .then(() => {
                        document.body.removeChild(testDiv);
                        resolve({
                            output: code,
                            error: null,
                            rendered: true
                        });
                    })
                    .catch((error) => {
                        document.body.removeChild(testDiv);
                        resolve({
                            output: code,
                            error: error.message || 'Render failed',
                            rendered: false
                        });
                    });
            });
        }

        function displayResults(testResults) {
            const container = document.getElementById('pipeline-results');
            const currentTest = document.getElementById('current-test');

            // Store test data for comparison view
            currentTestData = testResults;

            currentTest.style.display = 'block';

            const pipelineNames = {
                'raw': 'RAW',
                'python': 'Python Sanitizer',
                'mermaidjs': 'Mermaid.js Fix',
                'python_then_js': 'Python ‚Üí JS',
                'js_then_python': 'JS ‚Üí Python'
            };

            container.innerHTML = Object.entries(testResults).map(([key, result]) => {
                return renderPipelineCard(pipelineNames[key], result.output, result.error, result.rendered);
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function highlightMermaidCode(code) {
            // First escape HTML
            let escaped = escapeHtml(code);

            // Highlight keywords (flowchart, graph, subgraph, etc)
            escaped = escaped.replace(/\b(flowchart|graph|subgraph|end|direction|classDef|class|style|linkStyle)\b/g,
                '<span style="color: #ff79c6; font-weight: 600;">$1</span>');

            // Highlight direction keywords
            escaped = escaped.replace(/\b(LR|RL|TB|BT|TD)\b/g,
                '<span style="color: #ffb86c;">$1</span>');

            // Highlight arrows
            escaped = escaped.replace(/(--&gt;|---|-\.-&gt;|==&gt;|--)/g,
                '<span style="color: #8be9fd;">$1</span>');

            // Highlight node IDs (letters/numbers before brackets)
            escaped = escaped.replace(/\b([A-Za-z_][A-Za-z0-9_]*)\s*(\[|\(|\{)/g,
                '<span style="color: #50fa7b;">$1</span>$2');

            // Highlight strings in quotes
            escaped = escaped.replace(/(&quot;[^&]*&quot;)/g,
                '<span style="color: #f1fa8c;">$1</span>');

            // Highlight brackets content
            escaped = escaped.replace(/(\[[^\]]*\])/g,
                '<span style="color: #bd93f9;">$1</span>');

            return escaped;
        }

        // Store all tests for filtering
        let allTests = [];

        async function loadRecentTests() {
            try {
                console.log('[DEBUG] Fetching recent tests...');
                const response = await fetch(`${API_URL}/debug/recent-tests?limit=50`);
                const data = await response.json();
                console.log('[DEBUG] Got response:', data);

                if (data.success && data.tests && data.tests.length > 0) {
                    console.log(`[DEBUG] Loaded ${data.tests.length} tests`);
                    allTests = data.tests;
                    filterTests(); // Apply current filters
                    renderErrorLog(); // Also update error log
                } else {
                    console.log('[DEBUG] No tests found:', data);
                    document.getElementById('recent-tests-list').innerHTML = '<div class="loading">No tests captured yet. Use the main app to generate some graphs!</div>';
                    document.getElementById('error-frequency-list').innerHTML = '<div class="loading">No errors yet</div>';
                    document.getElementById('error-list-items').innerHTML = '<div class="loading">No errors yet</div>';
                }
            } catch (e) {
                console.error('[DEBUG] Error loading recent tests:', e);
                document.getElementById('recent-tests-list').innerHTML = `<div class="loading" style="color: #F87171;">Error loading tests: ${e.message}<br><br>Make sure Flask server is running on ${API_URL}</div>`;
            }
        }

        function renderErrorLog() {
            const pipelineFilter = document.getElementById('error-pipeline-filter').value;

            // Collect all errors from all tests
            const errors = [];
            const errorCounts = {};

            allTests.forEach(test => {
                const pipelines = [
                    { key: 'raw', name: 'RAW', error: test.raw_error, rendered: test.raw_rendered },
                    { key: 'python', name: 'Python', error: test.python_error, rendered: test.python_rendered },
                    { key: 'mermaidjs', name: 'Mermaid.js', error: test.mermaidjs_error, rendered: test.mermaidjs_rendered },
                    { key: 'python_then_js', name: 'Python‚ÜíJS', error: test.python_then_js_error, rendered: test.python_then_js_rendered },
                    { key: 'js_then_python', name: 'JS‚ÜíPython', error: test.js_then_python_error, rendered: test.js_then_python_rendered }
                ];

                pipelines.forEach(p => {
                    if (p.error && (pipelineFilter === 'all' || pipelineFilter === p.key)) {
                        // Normalize error message for counting (first line only, trimmed)
                        const normalizedError = p.error.split('\n')[0].trim().substring(0, 100);

                        errors.push({
                            testId: test.id,
                            pipeline: p.name,
                            pipelineKey: p.key,
                            error: p.error,
                            normalizedError: normalizedError,
                            timestamp: test.created_at
                        });

                        // Count occurrences
                        const countKey = `${p.key}:${normalizedError}`;
                        if (!errorCounts[countKey]) {
                            errorCounts[countKey] = {
                                pipeline: p.name,
                                error: normalizedError,
                                fullError: p.error,
                                count: 0
                            };
                        }
                        errorCounts[countKey].count++;
                    }
                });
            });

            // Render error frequency (top 10)
            const sortedCounts = Object.values(errorCounts).sort((a, b) => b.count - a.count).slice(0, 10);

            if (sortedCounts.length > 0) {
                const maxCount = sortedCounts[0].count;
                document.getElementById('error-frequency-list').innerHTML = sortedCounts.map(item => {
                    const barWidth = (item.count / maxCount) * 100;
                    return `
                        <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(248, 113, 113, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="color: #bc13fe; font-weight: 600; font-size: 1em;">${item.pipeline}</span>
                                <span style="background: rgba(248, 113, 113, 0.3); color: #F87171; font-weight: 700; padding: 4px 12px; border-radius: 12px; font-size: 0.9em;">${item.count}x occurrences</span>
                            </div>
                            <div style="background: rgba(248, 113, 113, 0.1); border-radius: 4px; overflow: hidden; margin-bottom: 12px; height: 6px;">
                                <div style="background: linear-gradient(90deg, #F87171, #fb923c); height: 100%; width: ${barWidth}%; border-radius: 4px;"></div>
                            </div>
                            <pre style="margin: 0; font-family: 'JetBrains Mono', monospace; font-size: 0.85em; color: #F87171; white-space: pre-wrap; word-wrap: break-word; background: rgba(0, 0, 0, 0.4); padding: 12px; border-radius: 6px; max-height: 200px; overflow-y: auto; line-height: 1.5;">${escapeHtml(item.fullError)}</pre>
                        </div>
                    `;
                }).join('');
            } else {
                document.getElementById('error-frequency-list').innerHTML = '<div style="color: #34D399; text-align: center; padding: 20px;">No errors found! All pipelines succeeded.</div>';
            }

            // Render full error list (most recent first)
            if (errors.length > 0) {
                document.getElementById('error-list-items').innerHTML = errors.slice(0, 50).map(err => `
                    <div style="background: rgba(248, 113, 113, 0.05); border: 1px solid rgba(248, 113, 113, 0.2); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <span style="color: #00f3ff; font-weight: 600;">Test #${err.testId}</span>
                                <span style="background: rgba(188, 19, 254, 0.2); color: #bc13fe; padding: 3px 8px; border-radius: 4px; font-size: 0.85em;">${err.pipeline}</span>
                            </div>
                            <span style="color: #888; font-size: 0.85em;">${new Date(err.timestamp).toLocaleString()}</span>
                        </div>
                        <pre style="margin: 0; font-family: 'JetBrains Mono', monospace; font-size: 0.85em; color: #F87171; white-space: pre-wrap; word-wrap: break-word; max-height: 150px; overflow-y: auto; background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 4px;">${escapeHtml(err.error)}</pre>
                    </div>
                `).join('');
            } else {
                document.getElementById('error-list-items').innerHTML = '<div style="color: #34D399; text-align: center; padding: 20px;">No errors found!</div>';
            }
        }

        function showErrorDetail(errorText) {
            const cleanError = errorText.replace(/\\`/g, '`').replace(/\\\$/g, '$');
            alert(cleanError);
        }

        function filterTests() {
            const methodFilter = document.getElementById('filter-method').value;
            const resultFilter = document.getElementById('filter-result').value;

            let filtered = allTests;

            // Filter by method
            if (methodFilter !== 'all') {
                filtered = filtered.filter(test => test.best_method === methodFilter);
            }

            // Filter by result
            if (resultFilter === 'success') {
                filtered = filtered.filter(test => {
                    return test.raw_rendered || test.python_rendered || test.mermaidjs_rendered ||
                           test.python_then_js_rendered || test.js_then_python_rendered;
                });
            } else if (resultFilter === 'failure') {
                filtered = filtered.filter(test => {
                    return !test.raw_rendered && !test.python_rendered && !test.mermaidjs_rendered &&
                           !test.python_then_js_rendered && !test.js_then_python_rendered;
                });
            }

            // Render filtered tests
            const container = document.getElementById('recent-tests-list');
            if (filtered.length > 0) {
                container.innerHTML = filtered.map(test => renderTestItem(test)).join('');
            } else {
                container.innerHTML = '<div class="loading">No tests match filters</div>';
            }
        }

        async function exportTests() {
            if (allTests.length === 0) {
                alert('No tests to export');
                return;
            }

            // Create CSV content
            const headers = ['ID', 'Timestamp', 'Best Method', 'RAW', 'Python', 'Mermaid.js', 'Py‚ÜíJS', 'JS‚ÜíPy', 'Session ID'];
            const rows = allTests.map(test => [
                test.id,
                new Date(test.created_at).toISOString(),
                test.best_method,
                test.raw_rendered ? 'Success' : 'Failed',
                test.python_rendered ? 'Success' : 'Failed',
                test.mermaidjs_rendered ? 'Success' : 'Failed',
                test.python_then_js_rendered ? 'Success' : 'Failed',
                test.js_then_python_rendered ? 'Success' : 'Failed',
                test.session_id || 'unknown'
            ]);

            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');

            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ghost-tests-${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function clearAllTests() {
            if (!confirm('‚ö†Ô∏è This will delete ALL test records from the database. Are you sure?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/debug/clear-test-database`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    alert('‚úÖ All tests cleared');
                    allTests = [];
                    loadStats();
                    loadRecentTests();
                } else {
                    alert('‚ùå Failed to clear tests');
                }
            } catch (e) {
                console.error('Error clearing tests:', e);
                alert('‚ùå Error: ' + e.message);
            }
        }
    </script>
</body>
</html>
