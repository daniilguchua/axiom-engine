<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nuclear Debugger (v3.0 - Mermaid v11)</title>
    <style>
        body { background: #0b0d12; color: #e0e0e0; font-family: 'Segoe UI', monospace; display: flex; gap: 20px; padding: 20px; height: 100vh; box-sizing: border-box; }
        .col { flex: 1; display: flex; flex-direction: column; gap: 10px; min-width: 0; }
        
        textarea { 
            background: #111; color: #00f3ff; border: 1px solid #333; 
            padding: 15px; height: 40%; font-family: 'Courier New'; font-size: 13px; 
            border-radius: 6px; resize: none;
        }
        
        #preview { 
            background: #1a1a1a; border: 1px solid #444; flex-grow: 1; 
            overflow: auto; padding: 20px; border-radius: 6px; display: flex;
            justify-content: center; align-items: flex-start;
        }
        
        button { 
            padding: 15px; background: #bc13fe; color: white; border: none; 
            cursor: pointer; font-weight: 700; font-size: 1em; letter-spacing: 1px;
            border-radius: 4px; transition: background 0.2s;
        }
        button:hover { background: #d655ff; }
        
        h3 { margin: 0; color: #888; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 8px; }
        
        #error-log { 
            display: none; background: #2a0000; border: 1px solid #ff4444; 
            color: #ff9999; padding: 15px; font-size: 0.85em; 
            white-space: pre-wrap; font-family: monospace; border-radius: 6px;
        }
    </style>
</head>
<body>

<div class="col">
    <h3>1. Paste Broken Code</h3>
    <textarea id="input">
graph TDsubgraph Auth_System["Authentication Core"]
direction TBUser(( "User" ))-->
Login_Form{{"Enter Credentials"}}
Login_Form-->Verify[["Verify Hash"]]
end
subgraph DB["Database"]User_Table[("Users")]end
Verify-->User_Table
classDef secure fill:#0f0;class User_Table secure
    </textarea>
    
    <button onclick="runTest()">⚡ RUN V11 REPAIR & RENDER</button>
    
    <h3>2. Sanitized Output</h3>
    <textarea id="output" readonly></textarea>
</div>

<div class="col">
    <h3>3. Result (Mermaid v11.3.0)</h3>
    <div id="preview"></div>
    <div id="error-log"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/mermaid@11.3.0/dist/mermaid.min.js"></script>

<script>
    mermaid.initialize({ startOnLoad: false, theme: 'dark', securityLevel: 'loose' });

    function sanitizeMermaidString(raw) {
  // PHASE 1: PRE-FLIGHT SANITIZATION (Characters & Encodings)

  let clean = raw.replace(/\\n/g, "\n");
  clean = clean.replace(/[“”]/g, '"').replace(/[‘’]/g, "'");
  clean = clean.replace(/^mermaid\s*/i, "").replace(/```mermaid/g, "").replace(/```/g, "").trim();
  // 2. MASKING (Protect Strings)

  const tokenMap = new Map();
  let tokenCounter = 0;
  clean = clean.replace(/"((?:\\.|[^\\])*?)"/g, (match) => {
    const token = `__MERM_STR_${tokenCounter++}__`;
    tokenMap.set(token, match); 
    return token;
  });

  clean = clean.replace(/[:\s][^#a-zA-Z0-9\s]([0-9a-fA-F]{6})/g, ":#$1");
  clean = clean.replace(/(fill|stroke|color):\s*([0-9a-fA-F]{6})(?![\w-])/g, "$1:#$2");
  clean = clean.replace(/([a-zA-Z0-9_]+):[a-zA-Z0-9_]+/g, "$1");
  clean = clean.replace(/--o/g, "-->");
  clean = clean.replace(/stroke-width\s*(?::|;|\s|$)/gi, "stroke-width:2px;");
  clean = clean.replace(/stroke-dasharray\s+(\d+)/gi, "stroke-dasharray:$1");
  clean = clean.replace(/(fill|stroke|stroke-width|color|stroke-dasharray)\s+([^:;]+)(?=;|}|,|$)/gi, "$1:$2");

  // PHASE 2: STRUCTURAL SURGERY 
  clean = clean.replace(/([a-zA-Z0-9_]+)\s+([0-9]+)(?=\[|\(|\{)/g, "$1_$2");
  clean = clean.replace(
    /\b(?!subgraph|graph|style|classDef|class|linkStyle)([a-zA-Z0-9_]+)\s+([a-zA-Z0-9_]+)(?=\[|\(|\{)/g, 
    "$1_$2"
  );

  // 4. CLASSDEF HOISTING (CRITICAL STABILITY FIX)
  // Extract ALL classDef lines, clean them, and store them to append later.
  // This prevents nesting errors inside subgraphs and fixes the "Expecting SEMI" crash.
  const classDefs = [];
  clean = clean.replace(/^\s*classDef\s+.*$/gm, (match) => {
      // Remove any existing semicolons from end, trim, then add exactly ONE unique semicolon
      let def = match.trim().replace(/;+$/, ''); 
      classDefs.push(def + ';'); 
      return ''; // Remove from body
  });

  // 5. THE NUCLEAR SEPARATOR (Node Splitting)

  clean = clean.replace(
      /((?:\]|\]\]|\)|\)\)|\}|>)+)(?:;)?\s*([a-zA-Z0-9_])/g, 
      "$1;\n$2"
  );
  
  // Keep the subgraph fix below it
  clean = clean.replace(/(subgraph\s+[a-zA-Z0-9_\-]+(?:\s*\[.*?\])?)/gi, "$1\n");

  // 6. KEYWORD ISOLATION
  const keywords = ["subgraph", "end", "style", "click", "linkStyle", "direction"];
  const keyPattern = new RegExp(`(\\s|^)(${keywords.join("|")})`, "gi");
  clean = clean.replace(keyPattern, "\n$2");

  clean = clean.replace(/([\)\}\]>]+)\s*end/gi, "$1;\nend");
  clean = clean.replace(/end\s*([a-zA-Z0-9])/gi, "end\n$1");

  // PHASE 2.5: ARROW REPAIR (Fixes Chimera Arrows)
  clean = clean.replace(/endsubgraph/gi, "end");
  clean = clean.replace(/end\s+[^\n;]+/gi, "end");
  clean = clean.replace(/(\S)end/gi, "$1\nend");

  clean = clean.replace(/--\s*(__MERM_STR_\d+__)\s*==>/g, '== $1 ==>');
  clean = clean.replace(/==\s*(__MERM_STR_\d+__)\s*-->/g, '-- $1 -->');

  clean = clean.replace(/;\s*([a-zA-Z])/g, ";\n$1");  clean = clean.replace(/;;/g, ';'); 
  clean = clean.replace(/(\S)(-->|==>|-\.->)(\S)/g, "$1 $2 $3");
  clean = clean.replace(/([a-zA-Z0-9_])\s+(\[|\(|\{)/g, "$1$2");

  // PHASE 3: RECONSTRUCTION & FINAL POLISH

  // 9. UNMASKING
  tokenMap.forEach((val, key) => {
    clean = clean.replace(key, val);
  });

  // 10. RE-INJECT CLASSDEFS (Global Scope)
  if (classDefs.length > 0) {
      const uniqueDefs = [...new Set(classDefs)];
      clean += '\n' + uniqueDefs.join('\n');
  }

  clean = clean.replace(/(graph|direction)\s+(TB|TD)/gi, "$1 LR");
  // 11. FINAL CLEANUP
  clean = clean.split("\n").map(l => l.trim()).filter(l => l).join("\n");
  
  // 12. HEADER INJECTION
  if (!/^(graph|flowchart|sequenceDiagram|classDiagram|stateDiagram|erDiagram|gantt)/i.test(clean)) {
    clean = "graph LR\n" + clean;
  }

  console.log("SANITIZER OUTPUT:", clean); 
  return clean;
}

    // --- UPDATED RENDER FUNCTION FOR V11 (ASYNC) ---
    window.runTest = async function() {
        const input = document.getElementById('input').value;
        const outputEl = document.getElementById('output');
        const previewEl = document.getElementById('preview');
        const errorEl = document.getElementById('error-log');

        const cleaned = sanitizeMermaidString(input);
        outputEl.value = cleaned;

        previewEl.innerHTML = '<span style="color:#666">Rendering...</span>';
        errorEl.style.display = 'none';

        try {
            // Check if the graph is valid code first
            if (cleaned.length < 10) throw new Error("Graph code too short.");

            const graphId = 'graphDiv-' + Date.now();
            
            // --- MERMAID V11 SYNTAX ---
            // .render() returns an object { svg: string }
            const { svg } = await mermaid.render(graphId, cleaned);
            
            previewEl.innerHTML = svg;
            
        } catch (e) {
            errorEl.style.display = 'block';
            errorEl.innerHTML = `<strong>⚠️ PARSE ERROR:</strong>\n${e.message}`;
            previewEl.innerHTML = '<span style="color:#ff4444; font-size: 2em;">☠️</span>';
            console.error(e);
        }
    };
</script>
</body>
</html>