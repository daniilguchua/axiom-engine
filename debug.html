<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHOST DEBUG // Sanitizer Tournament</title>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@11.3.0/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">

    <style>
        body {
            background: #0a0a0f;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
        }

        .debug-container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .debug-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(188, 19, 254, 0.3);
        }

        .debug-header h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2.5em;
            margin: 0;
            color: #bc13fe;
        }

        .debug-header p {
            font-size: 0.9em;
            color: #888;
            margin: 10px 0 0 0;
        }

        .debug-header a {
            color: #00f3ff;
            text-decoration: none;
        }

        .test-form {
            background: rgba(20, 20, 30, 0.6);
            border: 1px solid rgba(188, 19, 254, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .test-form h2 {
            margin-top: 0;
            color: #bc13fe;
            font-size: 1.3em;
        }

        .test-form textarea {
            width: 100%;
            min-height: 150px;
            background: #0a0a0f;
            border: 1px solid rgba(0, 243, 255, 0.3);
            border-radius: 4px;
            color: #e0e0e0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            padding: 10px;
            resize: vertical;
            box-sizing: border-box;
        }

        .test-form button {
            background: linear-gradient(135deg, #bc13fe, #8b10c7);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            margin-top: 10px;
        }

        .test-form button:hover {
            opacity: 0.9;
        }

        .test-form button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(20, 20, 30, 0.6);
            border: 1px solid rgba(0, 243, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 0.9em;
            color: #888;
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: 700;
            color: #00f3ff;
        }

        .pipeline-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .pipeline-card {
            background: rgba(20, 20, 30, 0.6);
            border: 1px solid rgba(0, 243, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
        }

        .pipeline-card.success {
            border-color: rgba(52, 211, 153, 0.6);
        }

        .pipeline-card.error {
            border-color: rgba(248, 113, 113, 0.6);
        }

        .pipeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .pipeline-name {
            font-weight: 700;
            font-size: 1.1em;
            color: #bc13fe;
        }

        .pipeline-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .pipeline-status.success {
            background: rgba(52, 211, 153, 0.2);
            color: #34D399;
        }

        .pipeline-status.error {
            background: rgba(248, 113, 113, 0.2);
            color: #F87171;
        }

        .pipeline-code {
            background: #0a0a0f;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85em;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
            color: #e0e0e0;
        }

        .pipeline-error {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.3);
            border-radius: 4px;
            padding: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85em;
            color: #F87171;
            margin-bottom: 10px;
        }

        .pipeline-render {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 243, 255, 0.2);
            border-radius: 4px;
            padding: 10px;
            min-height: 150px;
            overflow: auto;
        }

        .recent-tests {
            margin-top: 40px;
        }

        .recent-tests h2 {
            color: #bc13fe;
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        .test-item {
            background: rgba(20, 20, 30, 0.6);
            border: 1px solid rgba(0, 243, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .test-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .test-id {
            font-weight: 700;
            color: #00f3ff;
        }

        .best-method {
            padding: 4px 10px;
            background: rgba(188, 19, 254, 0.2);
            border-radius: 12px;
            font-size: 0.9em;
            color: #bc13fe;
        }

        .expand-btn {
            background: rgba(0, 243, 255, 0.2);
            border: 1px solid rgba(0, 243, 255, 0.3);
            color: #00f3ff;
            padding: 6px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .expand-btn:hover {
            background: rgba(0, 243, 255, 0.3);
        }

        .test-details {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .test-details.expanded {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
    </style>
</head>

<body>
    <div class="debug-container">
        <div class="debug-header">
            <h1>‚ö° GHOST DEBUG</h1>
            <p>Sanitizer Tournament - Compare all 5 repair pipelines side-by-side</p>
            <p><a href="index.html" style="color: #00f3ff;">‚Üê Back to Main App</a></p>
        </div>

        <!-- Submit New Test -->
        <div class="test-form">
            <h2>üß™ Test Raw Mermaid Code</h2>
            <p style="color: #888; font-size: 0.9em;">Paste raw LLM output to test through all 5 sanitization pipelines</p>
            <textarea id="raw-input" placeholder="flowchart LR;&#10;A['Start'];&#10;B['Process'];&#10;A --> B;"></textarea>
            <button id="submit-test" onclick="submitTest()">Run Test</button>
            <div id="test-status" style="margin-top: 10px; color: #888;"></div>
        </div>

        <!-- Statistics Panel -->
        <div class="stats-panel" id="stats-panel">
            <div class="stat-card">
                <h3>Total Tests</h3>
                <div class="value" id="stat-total">-</div>
            </div>
            <div class="stat-card">
                <h3>RAW Success</h3>
                <div class="value" id="stat-raw">-</div>
            </div>
            <div class="stat-card">
                <h3>Python Sanitizer</h3>
                <div class="value" id="stat-python">-</div>
            </div>
            <div class="stat-card">
                <h3>Mermaid.js Fix</h3>
                <div class="value" id="stat-mermaidjs">-</div>
            </div>
            <div class="stat-card">
                <h3>Python ‚Üí JS</h3>
                <div class="value" id="stat-python-js">-</div>
            </div>
            <div class="stat-card">
                <h3>JS ‚Üí Python</h3>
                <div class="value" id="stat-js-python">-</div>
            </div>
        </div>

        <!-- Current Test Results -->
        <div id="current-test" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #bc13fe; margin: 0;">Current Test Results</h2>
                <button onclick="showCodeComparison()" style="background: rgba(0, 243, 255, 0.2); border: 1px solid rgba(0, 243, 255, 0.3); color: #00f3ff; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Compare Code Changes</button>
            </div>
            <div class="pipeline-comparison" id="pipeline-results"></div>

            <!-- Code Comparison Modal -->
            <div id="comparison-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 1000; overflow-y: auto; padding: 20px;">
                <div style="max-width: 1400px; margin: 0 auto; background: #0a0a0f; border: 2px solid rgba(188, 19, 254, 0.5); border-radius: 8px; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #bc13fe; margin: 0;">üìä Code Transformation Comparison</h2>
                        <button onclick="closeComparison()" style="background: rgba(248, 113, 113, 0.2); border: 1px solid rgba(248, 113, 113, 0.3); color: #F87171; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Close</button>
                    </div>
                    <div id="comparison-content"></div>
                </div>
            </div>
        </div>

        <!-- Recent Tests -->
        <div class="recent-tests">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üìä Recent Tests</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="filter-method" onchange="filterTests()" style="background: rgba(20, 20, 30, 0.6); color: #e0e0e0; border: 1px solid rgba(0, 243, 255, 0.3); padding: 8px; border-radius: 4px; cursor: pointer;">
                        <option value="all">All Methods</option>
                        <option value="RAW">RAW Only</option>
                        <option value="PYTHON">Python Only</option>
                        <option value="MERMAIDJS">Mermaid.js Only</option>
                        <option value="PYTHON_THEN_JS">Python‚ÜíJS Only</option>
                        <option value="JS_THEN_PYTHON">JS‚ÜíPython Only</option>
                    </select>
                    <select id="filter-result" onchange="filterTests()" style="background: rgba(20, 20, 30, 0.6); color: #e0e0e0; border: 1px solid rgba(0, 243, 255, 0.3); padding: 8px; border-radius: 4px; cursor: pointer;">
                        <option value="all">All Results</option>
                        <option value="success">Success Only</option>
                        <option value="failure">Failures Only</option>
                    </select>
                    <button onclick="exportTests()" style="background: rgba(0, 243, 255, 0.2); border: 1px solid rgba(0, 243, 255, 0.3); color: #00f3ff; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Export CSV</button>
                    <button onclick="clearAllTests()" style="background: rgba(248, 113, 113, 0.2); border: 1px solid rgba(248, 113, 113, 0.3); color: #F87171; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Clear All</button>
                </div>
            </div>
            <div id="recent-tests-list">
                <div class="loading">Loading recent tests...</div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            securityLevel: 'loose',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true
            }
        });

        // Load stats and recent tests on page load
        window.addEventListener('load', () => {
            loadStats();
            loadRecentTests();
        });

        async function loadStats() {
            try {
                const response = await fetch('/debug/stats?days=7');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('stat-total').textContent = data.total_tests || 0;
                    document.getElementById('stat-raw').textContent = data.raw_success || 0;
                    document.getElementById('stat-python').textContent = data.python_success || 0;
                    document.getElementById('stat-mermaidjs').textContent = data.mermaidjs_success || 0;
                    document.getElementById('stat-python-js').textContent = data.python_then_js_success || 0;
                    document.getElementById('stat-js-python').textContent = data.js_then_python_success || 0;
                }
            } catch (e) {
                console.error('Error loading stats:', e);
            }
        }


        function renderTestItem(test) {
            return `
                <div class="test-item">
                    <div class="test-item-header">
                        <span class="test-id">Test #${test.id}</span>
                        <span class="best-method">${test.best_method}</span>
                        <span style="color: #888; font-size: 0.9em;">${new Date(test.created_at).toLocaleString()}</span>
                        <button class="expand-btn" onclick="toggleTestDetails(${test.id})">View Details</button>
                    </div>
                    <div class="test-details" id="test-details-${test.id}">
                        <div class="pipeline-comparison">
                            ${renderPipelineCard('RAW', test.raw_mermaid, test.raw_error, test.raw_rendered)}
                            ${renderPipelineCard('Python', test.python_output, test.python_error, test.python_rendered)}
                            ${renderPipelineCard('Mermaid.js', test.mermaidjs_output, test.mermaidjs_error, test.mermaidjs_rendered)}
                            ${renderPipelineCard('Py‚ÜíJS', test.python_then_js_output, test.python_then_js_error, test.python_then_js_rendered)}
                            ${renderPipelineCard('JS‚ÜíPy', test.js_then_python_output, test.js_then_python_error, test.js_then_python_rendered)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPipelineCard(name, output, error, rendered) {
            const statusClass = rendered ? 'success' : 'error';
            const statusText = rendered ? '‚úì Rendered' : '‚úó Failed';
            const codeId = `code-${Math.random().toString(36).substring(7)}`;

            return `
                <div class="pipeline-card ${statusClass}">
                    <div class="pipeline-header">
                        <div class="pipeline-name">${name}</div>
                        <div class="pipeline-status ${statusClass}">${statusText}</div>
                    </div>
                    ${error ? `<div class="pipeline-error"><strong>Error:</strong> ${escapeHtml(error)}</div>` : ''}
                    <div class="pipeline-code" style="max-height: 150px; cursor: pointer;" onclick="toggleCodeView('${codeId}')">
                        <div style="color: #888; font-size: 0.8em; margin-bottom: 5px;">Click to view full code ‚ñº</div>
                        ${escapeHtml(output || 'N/A').substring(0, 200)}${(output || '').length > 200 ? '...' : ''}
                    </div>
                    <div id="${codeId}" style="display: none; background: #000; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px; padding: 10px; margin-top: 10px; max-height: 600px; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 10px;">
                            <strong style="color: #00f3ff;">Full Transformed Code (${(output || '').length} chars)</strong>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="copyCode('${codeId}')" style="background: rgba(0, 243, 255, 0.2); border: 1px solid rgba(0, 243, 255, 0.3); color: #00f3ff; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85em;">Copy Code</button>
                                <button onclick="downloadCode('${codeId}', '${name}')" style="background: rgba(0, 243, 255, 0.2); border: 1px solid rgba(0, 243, 255, 0.3); color: #00f3ff; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85em;">Download</button>
                            </div>
                        </div>
                        <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word; font-family: 'JetBrains Mono', monospace; font-size: 0.85em; color: #e0e0e0; line-height: 1.5;">${escapeHtml(output || 'N/A')}</pre>
                    </div>
                </div>
            `;
        }

        function toggleCodeView(codeId) {
            const element = document.getElementById(codeId);
            if (element.style.display === 'none') {
                element.style.display = 'block';
            } else {
                element.style.display = 'none';
            }
        }

        function copyCode(codeId) {
            const element = document.getElementById(codeId);
            const code = element.querySelector('pre').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('‚úÖ Code copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('‚ùå Failed to copy code');
            });
        }

        function downloadCode(codeId, pipelineName) {
            const element = document.getElementById(codeId);
            const code = element.querySelector('pre').textContent;
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mermaid-${pipelineName.toLowerCase().replace(/\s+/g, '-')}-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Store current test results for comparison
        let currentTestData = null;

        function showCodeComparison() {
            if (!currentTestData) {
                alert('No test data available');
                return;
            }

            const modal = document.getElementById('comparison-modal');
            const content = document.getElementById('comparison-content');

            const pipelines = ['raw', 'python', 'mermaidjs', 'python_then_js', 'js_then_python'];
            const names = {
                'raw': 'RAW (No Changes)',
                'python': 'Python Sanitizer',
                'mermaidjs': 'Mermaid.js Fixer',
                'python_then_js': 'Python ‚Üí JS',
                'js_then_python': 'JS ‚Üí Python'
            };

            let html = '<div style="display: grid; gap: 20px;">';

            // Show each pipeline's code with character count
            for (const pipeline of pipelines) {
                const data = currentTestData[pipeline];
                const code = data.output || '';
                const lines = code.split('\n');

                html += `
                    <div style="background: rgba(20, 20, 30, 0.6); border: 1px solid rgba(0, 243, 255, 0.3); border-radius: 8px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 10px;">
                            <strong style="color: #bc13fe; font-size: 1.1em;">${names[pipeline]}</strong>
                            <div style="color: #888; font-size: 0.9em;">
                                ${code.length} chars | ${lines.length} lines |
                                <span style="color: ${data.rendered ? '#34D399' : '#F87171'};">${data.rendered ? '‚úì Rendered' : '‚úó Failed'}</span>
                            </div>
                        </div>
                        ${data.error ? `<div style="background: rgba(248, 113, 113, 0.1); border: 1px solid rgba(248, 113, 113, 0.3); padding: 8px; margin-bottom: 10px; border-radius: 4px; color: #F87171; font-size: 0.9em;"><strong>Error:</strong> ${escapeHtml(data.error)}</div>` : ''}
                        <pre style="background: #000; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px; padding: 10px; margin: 0; max-height: 300px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; font-family: 'JetBrains Mono', monospace; font-size: 0.85em; color: #e0e0e0; line-height: 1.5;">${escapeHtml(code)}</pre>
                    </div>
                `;
            }

            html += '</div>';
            content.innerHTML = html;
            modal.style.display = 'block';
        }

        function closeComparison() {
            document.getElementById('comparison-modal').style.display = 'none';
        }

        function toggleTestDetails(testId) {
            const details = document.getElementById(`test-details-${testId}`);
            details.classList.toggle('expanded');
        }

        async function submitTest() {
            const rawInput = document.getElementById('raw-input').value.trim();
            const submitBtn = document.getElementById('submit-test');
            const statusDiv = document.getElementById('test-status');

            if (!rawInput) {
                statusDiv.textContent = '‚ö†Ô∏è Please enter Mermaid code';
                statusDiv.style.color = '#F87171';
                return;
            }

            submitBtn.disabled = true;
            statusDiv.textContent = 'üîÑ Testing through all pipelines...';
            statusDiv.style.color = '#00f3ff';

            try {
                // Step 1: Capture raw and get pipeline versions
                const captureResponse = await fetch('/debug/capture-raw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        raw_mermaid: rawInput,
                        session_id: 'debug_session',
                        prompt: 'Manual debug test'
                    })
                });

                const captureData = await captureResponse.json();

                if (!captureData.success) {
                    throw new Error(captureData.error || 'Failed to capture');
                }

                // Step 2: Test each pipeline
                const testResults = {};
                const pipelines = ['raw', 'python', 'mermaidjs', 'python_then_js', 'js_then_python'];

                for (const pipeline of pipelines) {
                    const code = captureData.pipelines[pipeline];
                    const result = await testMermaidRendering(code, pipeline);
                    testResults[pipeline] = result;
                }

                // Step 3: Display results
                displayResults(testResults);

                // Step 4: Log to database
                await fetch('/debug/log-test-results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        raw_mermaid: rawInput,
                        session_id: 'debug_session',
                        test_results: testResults
                    })
                });

                statusDiv.textContent = '‚úÖ Test complete! Results displayed below.';
                statusDiv.style.color = '#34D399';

                // Refresh stats and recent tests
                loadStats();
                loadRecentTests();

            } catch (error) {
                console.error('Test error:', error);
                statusDiv.textContent = `‚ùå Error: ${error.message}`;
                statusDiv.style.color = '#F87171';
            } finally {
                submitBtn.disabled = false;
            }
        }

        async function testMermaidRendering(code, pipelineName) {
            return new Promise((resolve) => {
                const testDiv = document.createElement('div');
                testDiv.className = 'mermaid';
                testDiv.style.display = 'none';
                testDiv.textContent = code;
                document.body.appendChild(testDiv);

                mermaid.run({ nodes: [testDiv] })
                    .then(() => {
                        document.body.removeChild(testDiv);
                        resolve({
                            output: code,
                            error: null,
                            rendered: true
                        });
                    })
                    .catch((error) => {
                        document.body.removeChild(testDiv);
                        resolve({
                            output: code,
                            error: error.message || 'Render failed',
                            rendered: false
                        });
                    });
            });
        }

        function displayResults(testResults) {
            const container = document.getElementById('pipeline-results');
            const currentTest = document.getElementById('current-test');

            // Store test data for comparison view
            currentTestData = testResults;

            currentTest.style.display = 'block';

            const pipelineNames = {
                'raw': 'RAW',
                'python': 'Python Sanitizer',
                'mermaidjs': 'Mermaid.js Fix',
                'python_then_js': 'Python ‚Üí JS',
                'js_then_python': 'JS ‚Üí Python'
            };

            container.innerHTML = Object.entries(testResults).map(([key, result]) => {
                return renderPipelineCard(pipelineNames[key], result.output, result.error, result.rendered);
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Store all tests for filtering
        let allTests = [];

        async function loadRecentTests() {
            try {
                const response = await fetch('/debug/recent-tests?limit=50');
                const data = await response.json();

                if (data.success && data.tests.length > 0) {
                    allTests = data.tests;
                    filterTests(); // Apply current filters
                } else {
                    document.getElementById('recent-tests-list').innerHTML = '<div class="loading">No tests yet</div>';
                }
            } catch (e) {
                console.error('Error loading recent tests:', e);
                document.getElementById('recent-tests-list').innerHTML = '<div class="loading">Error loading tests</div>';
            }
        }

        function filterTests() {
            const methodFilter = document.getElementById('filter-method').value;
            const resultFilter = document.getElementById('filter-result').value;

            let filtered = allTests;

            // Filter by method
            if (methodFilter !== 'all') {
                filtered = filtered.filter(test => test.best_method === methodFilter);
            }

            // Filter by result
            if (resultFilter === 'success') {
                filtered = filtered.filter(test => {
                    return test.raw_rendered || test.python_rendered || test.mermaidjs_rendered ||
                           test.python_then_js_rendered || test.js_then_python_rendered;
                });
            } else if (resultFilter === 'failure') {
                filtered = filtered.filter(test => {
                    return !test.raw_rendered && !test.python_rendered && !test.mermaidjs_rendered &&
                           !test.python_then_js_rendered && !test.js_then_python_rendered;
                });
            }

            // Render filtered tests
            const container = document.getElementById('recent-tests-list');
            if (filtered.length > 0) {
                container.innerHTML = filtered.map(test => renderTestItem(test)).join('');
            } else {
                container.innerHTML = '<div class="loading">No tests match filters</div>';
            }
        }

        async function exportTests() {
            if (allTests.length === 0) {
                alert('No tests to export');
                return;
            }

            // Create CSV content
            const headers = ['ID', 'Timestamp', 'Best Method', 'RAW', 'Python', 'Mermaid.js', 'Py‚ÜíJS', 'JS‚ÜíPy', 'Session ID'];
            const rows = allTests.map(test => [
                test.id,
                new Date(test.created_at).toISOString(),
                test.best_method,
                test.raw_rendered ? 'Success' : 'Failed',
                test.python_rendered ? 'Success' : 'Failed',
                test.mermaidjs_rendered ? 'Success' : 'Failed',
                test.python_then_js_rendered ? 'Success' : 'Failed',
                test.js_then_python_rendered ? 'Success' : 'Failed',
                test.session_id || 'unknown'
            ]);

            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');

            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ghost-tests-${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function clearAllTests() {
            if (!confirm('‚ö†Ô∏è This will delete ALL test records from the database. Are you sure?')) {
                return;
            }

            try {
                const response = await fetch('/debug/clear-test-database', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    alert('‚úÖ All tests cleared');
                    allTests = [];
                    loadStats();
                    loadRecentTests();
                } else {
                    alert('‚ùå Failed to clear tests');
                }
            } catch (e) {
                console.error('Error clearing tests:', e);
                alert('‚ùå Error: ' + e.message);
            }
        }
    </script>
</body>
</html>
